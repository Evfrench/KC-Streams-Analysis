---
title: "KC Analysis Methods Draft"
author: "Em French"
date: "2023-05-04"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(forecast)
library(EGRET)
library(MARSS)
library(tidyverse)
library(dplyr)
library(data.table)
library(smwrBase)
source('./functions/get_socrata_data_func.R')
```

# Wrangle Data

```{r wrangle data}
####################################
#
# Start of Scripting and Plot Making 
#
####################################
  
# Query Socrata for the chosen site records, in this case Green River, Cedar River, and Issaquah Creek
# Need to... Call? Initialize? the funtions
GreenRiverData<- get_socrata_data_func(locns = c('A319'),
  parms = default_data_parms,
  SiteType = 'Streams and Rivers'
)


# We can normalize and make the reading more accessible py passing raw data through this function
GreenRiverDataExpanded = normalize_water_quality_data_parameters(GreenRiverData)

# Arrange the Rows by Collection date
GreenRiverDataExpanded <- arrange(GreenRiverDataExpanded,GreenRiverDataExpanded$CollectDate)

# There are two fields for DO, KC determine they have comparable detection results
# That means we can merge the two columns
GreenRiverDataExpanded$Dissolved_Oxygen <- GreenRiverDataExpanded$Dissolved_Oxygen + GreenRiverDataExpanded$`Dissolved_Oxygen,_Field`

# Merge the log values as well
GreenRiverDataExpanded$Dissolved_Oxygen_log <- GreenRiverDataExpanded$Dissolved_Oxygen_log + GreenRiverDataExpanded$`Dissolved_Oxygen,_Field_log`

# Remove one instance of duplicate values, will use the lab sample because it was collected regularly at this point
GreenRiverDataExpanded$Dissolved_Oxygen[267] <- GreenRiverDataExpanded$Dissolved_Oxygen[267] - GreenRiverDataExpanded$`Dissolved_Oxygen,_Field`[267]
GreenRiverDataExpanded$Dissolved_Oxygen_log[267] <- GreenRiverDataExpanded$Dissolved_Oxygen_log[267] - GreenRiverDataExpanded$`Dissolved_Oxygen,_Field_log`[267]


```

# Initial Plots

These plot show a large gap from \~2008 to \~2012 There are a lot of 0's
in the data set because two columns are merged, these need to be removed

```{r River Plots}
#Create Dissolved Oxygen Plots

GreenRiverDataExpanded %>%
  ggplot(aes(x=CollectDate, y=Dissolved_Oxygen)) +
  geom_line() +
  ggtitle("Green River DO")

green_river_daily_averages %>%
  ggplot(aes(x=Date, y=AveQ)) +
  geom_line() +
  ggtitle("Green River Daily Flows")

```

## Formating to fit the models

From the WRTDS_Sample_Workflow file, it looks like the sample dataframe
needs a number of fields that were not imported from the KC database, so
they have to be added manually

```{r format data for WRTDS}
# Pull out Just the stuff we need and replace the 0's with empty values
GreenDO <- subset(GreenRiverDataExpanded, select = c(CollectDate, Year, Month, Dissolved_Oxygen))
GreenDO <- replace(GreenDO, GreenDO==0, NA)
GreenDO <- GreenDO %>% 
  rename(Date = CollectDate,
         ConcAve = Dissolved_Oxygen)

# Add all of the missing fields for WRTDS
GreenDO$ConcLow <- GreenDO$ConcAve
GreenDO$ConcHigh <- GreenDO$ConcAve
GreenDO$DecYear <- decimal_date(GreenDO$Date)
GreenDO$SinDY <- sin(2*pi*GreenDO$DecYear)
GreenDO$CosDY <- cos(2*pi*GreenDO$DecYear)
GreenDO$Uncen <- NA
GreenDO$Uncen <- c(1)
GreenDO$Date <- as_date(GreenDO$Date)
GreenDO$RefDate <- as_date("1850-01-01")
GreenDO$Julian<- difftime(GreenDO$Date, GreenDO$RefDate, units = "days")
GreenDO$Julian <- as.integer(GreenDO$Julian)
GreenDO$MonthSeq <- interval(GreenDO$RefDate, GreenDO$Date) %/% months(1)
GreenDO$waterYear <- waterYear(GreenDO$Date, numeric = FALSE)

#Quick plot of new data
GreenDO %>%
  ggplot(aes(x=Date, y=ConcAve)) +
  geom_line() +
  ggtitle("Green River DO")
```

Much better, This almost looks like the DO is steadily decreasing or
staying constant

# WRTDS

The model appears to converge. I still need to do some diagnostics

```{r WRTDS Attempt}

yr_frst <- as_date("1976-04-13")
yr_last <- as_date("2008-12-03")
GreenDO <- GreenDO[GreenDO[, "Date"] >= yr_frst & GreenDO[, "Date"] <= yr_last,]
row.names(GreenDO) <- NULL
# Gather discharge data:
siteID <- "12113000" #Green River in Auburn, WA

# Gather sample data:
parameter_cd<-"00300" #5 digit USGS code, this is the dissolved oxygen
#Sample <- readNWISSample(siteID,parameter_cd,startDate,endDate) We collected this from the 
#Sample <- generate_egret_sample_from_water_quality_data(GreenRiverDataExpanded, unique(GreenRiverData$Parameter)) Commenting out until it works
Sample <- GreenDO #The sample data cannot be retrieve from the NWIS because it 
# comes from King County

# Gather discharge data:
# The Green River Gauge is actually 3.5km downstream from the King County site,
# Another creek merges with it during that time, so we must subtract those discharges
# The corrected discharge data were collected and stored in the cache, so we need to
# import the data and replace all the discharge values with those in the .csv
green_river_daily_averages <- fread('./data_cache/green_river_daily_averages.csv')
Daily <- readNWISDaily(siteID,"00060",yr_frst,yr_last)

Daily$Q <- green_river_daily_averages$Q
Daily$LogQ <- green_river_daily_averages$LogQ
Daily$Q7 <- green_river_daily_averages$Q7
Daily$Q30 <- green_river_daily_averages$Q30


# Gather site and parameter information:
# Here user must input some values for
# the default (interactive=TRUE)
INFO<- readNWISInfo(siteID,parameter_cd)
INFO$shortName <- "Green River at Aurburn, WA"

# Merge discharge with sample data:
eList <- mergeReport(INFO, Daily, Sample)

# Run WRTDS model:
eList <- modelEstimation(eList)

#eList:
plotConcTimeDaily(eList)

plotConcHist(eList)
```

# DLM

Everything should be in the correct form? The model took about half an
hour to run 1000 iterations but it failed to converge. The message is as
follows:

Warning! Reached maxit before parameters converged. Maxit was 1000.
neither abstol nor log-log convergence tests were passed.

MARSS fit is Estimation method: kem Convergence test:
conv.test.slope.tol = 0.5, abstol = 0.001 WARNING: maxit reached at 1000
iter before convergence. Neither abstol nor log-log convergence test
were passed. The likelihood and params are not at the ML values. Try
setting control\$maxit higher.

```{r DLM Attempt}
# Merge the water quality (Sample) and the discharge (Daily) frames
# Discharge dataframe has daily records, while the quality frame has bi-monthly
# This means the response variable will have lots of missing entries
marsFrame <- full_join(Sample, Daily, by = "Date") 
marsFrame <- arrange(marsFrame,marsFrame$Date)
marsFrame$SinDY <- sin(2*pi*marsFrame$DecYear.y)
marsFrame$CosDY <- cos(2*pi*marsFrame$DecYear.y)

# Response variable: log(Dissolved Oxygen)
DO = ts(t(log(marsFrame$ConcAve)))

TT = nrow(marsFrame)

#Covariates: Time(as the decimal year), Daily ave discharge (logQ), seasonal effects (sin and cos of the decimal year)
Z = array(NA,c(1,5,TT))
Z[1,1,] = c(1)
Z[1,2,] = marsFrame$DecYear.y
Z[1,3,] = marsFrame$LogQ
Z[1,4,] = marsFrame$SinDY
Z[1,5,] = marsFrame$CosDY

modlist = list( #all other arguments are left at default
  Z = Z,
  U = "zero",
  A = "zero",
  B = "identity",
  Q = "diagonal and unequal"
)
# initial effects were set to 0, maybe 1 would be better
marsfit <- MARSS(DO, model = modlist, inits = list(x0 = matrix(c(0),5,1)),  control = list(maxit=1000))
```

```{r Residuals}



```
